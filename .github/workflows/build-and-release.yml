name: Build and Release

on:
  push:
    branches:
      - main  # Altere para 'master' se essa for sua branch principal
    tags:
      - 'v*'  # Dispara quando uma tag com formato v* Ã© criada
  workflow_dispatch:  # Permite executar manualmente pela interface do GitHub

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write  # NecessÃ¡rio para criar releases e fazer upload de assets
      actions: read    # Leitura bÃ¡sica de aÃ§Ãµes
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # NecessÃ¡rio para ter acesso completo ao histÃ³rico do git

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Instalar dependÃªncias
        run: npm ci

      - name: Obter versÃ£o do package.json
        id: package-version
        run: |
          $version = (Get-Content package.json | ConvertFrom-Json).version
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "VersÃ£o detectada: $version"

      - name: Build da aplicaÃ§Ã£o (sem publicar)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Build sem publicar (--publish=never para gerar arquivos mas nÃ£o criar release)
          npm run build:win -- --publish=never

      - name: Criar tag se nÃ£o existir
        id: tag
        uses: actions/github-script@v7
        env:
          VERSION: ${{ steps.package-version.outputs.version }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = process.env.VERSION;
            const tagName = `v${version}`;
            
            try {
              // Verificar se a tag jÃ¡ existe
              const { data: tag } = await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/${tagName}`
              });
              
              console.log(`Tag ${tagName} jÃ¡ existe.`);
              core.setOutput('tag_exists', 'true');
            } catch (error) {
              if (error.status === 404) {
                // Tag nÃ£o existe, criar uma nova
                console.log(`Criando tag ${tagName}...`);
                
                // Obter SHA do commit atual
                const { data: ref } = await github.rest.git.getRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: 'heads/main'
                });
                
                const sha = ref.object.sha;
                
                // Criar a tag
                await github.rest.git.createRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `refs/tags/${tagName}`,
                  sha: sha
                });
                
                console.log(`Tag ${tagName} criada com sucesso!`);
                core.setOutput('tag_exists', 'false');
              } else {
                throw error;
              }
            }

      - name: Criar ou obter Release
        id: release
        uses: actions/github-script@v7
        env:
          VERSION: ${{ steps.package-version.outputs.version }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = process.env.VERSION;
            const tagName = `v${version}`;
            
            // Verificar se jÃ¡ existe release
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            let existingRelease = releases.find(
              release => release.tag_name === tagName
            );
            
            let releaseId;
            let uploadUrl;
            
            if (existingRelease) {
              console.log(`Release ${tagName} jÃ¡ existe. Usando release existente.`);
              releaseId = existingRelease.id;
              uploadUrl = existingRelease.upload_url;
            } else {
              console.log(`Criando nova release: ${tagName}`);
              const { data: release } = await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tagName,
                name: `MontShop Desktop v${version}`,
                body: `## ðŸš€ MontShop Desktop v${version}\n\n` +
                      `AtualizaÃ§Ã£o automÃ¡tica criada pelo GitHub Actions.\n\n` +
                      `**Data:** ${new Date().toLocaleString('pt-BR')}\n\n` +
                      `**Commit:** ${context.sha.substring(0, 7)}\n\n` +
                      `### ðŸ“¥ InstalaÃ§Ã£o\n\n` +
                      `1. Baixe o arquivo \`MontShop-Desktop-Setup-${version}.exe\`\n` +
                      `2. Execute o instalador\n` +
                      `3. A aplicaÃ§Ã£o serÃ¡ atualizada automaticamente na prÃ³xima vez que abrir\n\n` +
                      `### âš¡ AtualizaÃ§Ã£o AutomÃ¡tica\n\n` +
                      `Se vocÃª jÃ¡ tem o MontShop Desktop instalado, a atualizaÃ§Ã£o serÃ¡ baixada e instalada automaticamente ao fechar o aplicativo.`,
                draft: false,
                prerelease: false
              });
              
              releaseId = release.id;
              uploadUrl = release.upload_url;
              console.log(`Release criada: ${release.html_url}`);
            }
            
            core.setOutput('release_id', releaseId);
            core.setOutput('upload_url', uploadUrl);

      - name: Fazer upload do instalador (.exe)
        uses: actions/github-script@v7
        env:
          RELEASE_ID: ${{ steps.release.outputs.release_id }}
          UPLOAD_URL: ${{ steps.release.outputs.upload_url }}
          VERSION: ${{ steps.package-version.outputs.version }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const filePath = `./release/MontShop-Desktop-Setup-${process.env.VERSION}.exe`;
            
            if (!fs.existsSync(filePath)) {
              throw new Error(`Arquivo nÃ£o encontrado: ${filePath}`);
            }
            
            const fileContent = fs.readFileSync(filePath);
            const fileName = path.basename(filePath);
            const releaseId = parseInt(process.env.RELEASE_ID);
            
            // Verificar se o arquivo jÃ¡ existe na release
            const { data: assets } = await github.rest.repos.listReleaseAssets({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: releaseId,
            });
            
            const existingAsset = assets.find(asset => asset.name === fileName);
            
            if (existingAsset) {
              console.log(`Arquivo ${fileName} jÃ¡ existe na release. Deletando versÃ£o antiga...`);
              await github.rest.repos.deleteReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                asset_id: existingAsset.id,
              });
              console.log(`âœ… Arquivo antigo deletado.`);
            }
            
            // Fazer upload do novo arquivo
            await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: releaseId,
              name: fileName,
              data: fileContent,
              headers: {
                'content-type': 'application/octet-stream',
                'content-length': fileContent.length
              }
            });
            
            console.log(`âœ… Arquivo ${fileName} enviado com sucesso!`);

      - name: Fazer upload do latest.yml (para atualizaÃ§Ã£o automÃ¡tica)
        uses: actions/github-script@v7
        env:
          RELEASE_ID: ${{ steps.release.outputs.release_id }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const filePath = './release/latest.yml';
            const releaseId = parseInt(process.env.RELEASE_ID);
            
            let ymlFilePath = null;
            
            if (!fs.existsSync(filePath)) {
              console.log('âš ï¸ Arquivo latest.yml nÃ£o encontrado. Tentando localizar...');
              // Tentar encontrar em subdiretÃ³rios
              const releaseDir = './release';
              if (fs.existsSync(releaseDir)) {
                const files = fs.readdirSync(releaseDir, { recursive: true });
                const ymlFile = files.find(f => f.includes('latest.yml') || (f.endsWith('.yml') && f.includes('latest')));
                
                if (ymlFile) {
                  ymlFilePath = path.join(releaseDir, ymlFile);
                  console.log(`âœ… Encontrado: ${ymlFilePath}`);
                } else {
                  console.log('âš ï¸ Arquivo latest.yml nÃ£o encontrado. O electron-builder pode nÃ£o ter gerado ainda.');
                  console.log('Isso nÃ£o Ã© crÃ­tico - o electron-updater ainda funcionarÃ¡ sem este arquivo.');
                  return;
                }
              } else {
                console.log('âš ï¸ DiretÃ³rio release nÃ£o encontrado.');
                return;
              }
            } else {
              ymlFilePath = filePath;
            }
            
            if (!ymlFilePath) {
              return;
            }
            
            const fileContent = fs.readFileSync(ymlFilePath);
            
            // Verificar se o arquivo jÃ¡ existe na release
            const { data: assets } = await github.rest.repos.listReleaseAssets({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: releaseId,
            });
            
            const existingAsset = assets.find(asset => asset.name === 'latest.yml');
            
            if (existingAsset) {
              console.log('Arquivo latest.yml jÃ¡ existe na release. Deletando versÃ£o antiga...');
              await github.rest.repos.deleteReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                asset_id: existingAsset.id,
              });
              console.log('âœ… Arquivo antigo deletado.');
            }
            
            // Fazer upload do novo arquivo
            await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: releaseId,
              name: 'latest.yml',
              data: fileContent,
              headers: {
                'content-type': 'application/x-yaml',
                'content-length': fileContent.length
              }
            });
            
            console.log('âœ… Arquivo latest.yml enviado com sucesso!');

      - name: Resumo do build
        run: |
          echo "âœ… Build concluÃ­do com sucesso!"
          echo "ðŸ“¦ VersÃ£o: ${{ steps.package-version.outputs.version }}"
          echo "ðŸ”— Release: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.package-version.outputs.version }}"
          echo ""
          echo "Os usuÃ¡rios receberÃ£o a atualizaÃ§Ã£o automaticamente quando abrirem o aplicativo."

